<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">

  <!-- ページタイトル -->
  <title>スイーツカフェ セルフオーダー（QR対応）</title>

  <style>
/* ===============================
   全体レイアウト設定
=============================== */
body {
  font-family: 'Yu Gothic', sans-serif;
  background: #fff0f5;
  color: #4b2e2e;
  padding: 16px;
  font-size: 20px; /* ←大きく */
  line-height: 1.6;
}

/* タイトル */
h1 {
  text-align: center;
  font-size: 52px; /* ←大きく */
  color: #d86c9b;
  margin-bottom: 24px;
}

/* フォーム */
form {
  background: #ffffff;
  max-width: 650px; /* ←少し広めに */
  margin: 0 auto 40px;
  padding: 24px;
  border-radius: 18px;
  box-shadow: 0 4px 24px rgba(216, 108, 155, 0.25);
}

/* ラベル */
label {
  display: block;
  margin-top: 18px;
  font-weight: bold;
  color: #d86c9b;
  font-size: 35px; /* ←大きく */
}

/* セレクト・テキストエリア */
select,
textarea {
  width: 100%;
  padding: 16px; /* ←タップしやすく */
  border: 1px solid #ccc;
  border-radius: 12px;
  margin-top: 10px;
  font-size: 30px; /* ←大きく */
  min-height: 52px;
}

textarea {
  height: 120px; /* ←広げる */
}

/* ボタン */
button {
  margin-top: 28px;
  padding: 32px; /* ←タップしやすく */
  background: #d86c9b;
  border: none;
  border-radius: 14px;
  color: white;
  font-size: 35px; /* ←大きく */
  font-weight: bold;
  cursor: pointer;
  width: 100%;
}

button:disabled {
  background: #f0b6d1;
  cursor: not-allowed;
}

/* メニュー */
.menu-container {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.menu-item {
  position: relative;
  width: 100%;
  overflow: hidden;
  border-radius: 18px;
  box-shadow: 0 4px 16px rgba(216, 108, 155, 0.25); /* ←影追加 */
}

.menu-item img {
  width: 100%;
  height: auto;
  display: block;
}

.menu-select {
  position: relative;
  background: rgba(255,255,255,.95);
  padding: 16px;
}

.menu-select label {
  font-size: 35px;
}

.menu-select select {
  font-size: 35px;
}

/* 履歴 */
#history {
  max-width: 650px;
  margin: 0 auto;
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 4px 20px rgba(216, 108, 155, 0.25);
  padding: 24px;
}

#history h2 {
  text-align: center;
  color: #d86c9b;
  font-size: 24px;
}

.history-item {
  border-bottom: 1px solid #eee;
  padding: 16px 0;
  font-size: 18px;
}

.history-time {
  color: #888;
  font-size: 16px;
}

/* スマホ最適化 */
@media (max-width: 480px) {
  body { font-size: 22px; } /* ←さらに大きく */
  h1 { font-size: 30px; }
  label, select, textarea, button {
    font-size: 22px;
  }
  button {
    padding: 24px;
  }
}

  </style>
</head>

<body>

  <!-- ページタイトル -->
  <h1>セルフオーダーQR</h1>

  <!-- QRから取得したテーブル番号表示 -->
  <p id="tableDisplay" style="text-align:center; font-size:32px; color:#d86c9b;"></p>

  <!-- ===============================
       注文フォーム
  =============================== -->
  <form id="orderForm">

    <!-- テーブル番号（QRから自動取得） -->
    <input type="hidden" id="table" name="table" value="">

    <!-- メニュー一覧 -->
    <div class="menu-container">

      <!-- スイーツパフェ -->
      <div class="menu-item">
        <img src="images/parfait.jpg" alt="スイーツパフェ">
        <div class="menu-select">
          <label for="parfait">スイーツパフェ</label>
          <select id="parfait" name="parfait">
            <option value="0">選択してください</option>
            <option value="1">1個</option>
            <option value="2">2個</option>
          </select>
        </div>
      </div>

      <!-- スペシャルパフェ -->
      <div class="menu-item">
        <img src="images/special.jpg" alt="スペシャルパフェ">
        <div class="menu-select">
          <label for="special">スペシャルパフェ</label>
          <select id="special" name="special">
            <option value="0">選択してください</option>
            <option value="1">1個</option>
            <option value="2">2個</option>
          </select>
        </div>
      </div>

      <!-- スイーツプレート -->
      <div class="menu-item">
        <img src="images/plate.jpg" alt="スイーツプレート">
        <div class="menu-select">
          <label for="plate">スイーツプレート</label>
          <select id="plate" name="plate">
            <option value="0">選択してください</option>
            <option value="1">1皿</option>
            <option value="2">2皿</option>
          </select>
        </div>
      </div>

      <!-- ドリンク -->
      <div class="menu-item">
        <img src="images/drink.jpg" alt="ドリンク">
        <div class="menu-select">
          <label for="drink">ドリンク</label>
          <select id="drink" name="drink">
            <option value="0">選択してください</option>
            <option value="ブレンドコーヒー">ブレンドコーヒー</option>
            <option value="アップルティー">アップルティー</option>
            <option value="ミルクティー">ミルクティー</option>
            <option value="レモンティー">レモンティー</option>
          </select>
        </div>
      </div>

    </div>

    <!-- 店への連絡欄 -->
    <label for="message">お店への連絡</label>
    <textarea id="message" name="message" placeholder="アレルギー、テーブル上の要望など"></textarea>

    <!-- 送信エリア -->
    <div class="submit-row">
      <button type="submit" id="submitBtn" disabled>注文を送信</button>
      <p id="thanksMessage" style="display: none;">ご注文ありがとうございました。</p>
    </div>

  </form>

  <!-- ===============================
       注文履歴表示エリア
  =============================== -->
  <div id="history">
    <h2>注文履歴</h2>
    <div id="historyList"></div>
  </div>

  <script>

    // ===============================
    // DOM取得
    // ===============================
    const form = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');

    // ===============================
    // Supabase 接続情報
    // ===============================
    const SUPABASE_URL = "https://sdgdgkolzvymvhtwccyh.supabase.co";
    const SUPABASE_TABLE = "orders";
    const SUPABASE_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkZ2Rna29senZ5bXZodHdjY3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1OTkwMzEsImV4cCI6MjA1ODE3NTAzMX0.YFWg6dpsmC-msTlk9j4a8smc0TnZB2eI3l0HhF1GLH8";

    // ===============================
    // ページ読み込み時処理
    // URLから ?table=番号 を取得
    // ===============================
    window.addEventListener('DOMContentLoaded', () => {

      const params = new URLSearchParams(window.location.search);
      const tableParam = params.get('table');

      if (tableParam) {

        const tableInput = document.getElementById('table');
        tableInput.value = tableParam;

        // changeイベントを人工的に発火
        tableInput.dispatchEvent(new Event('change'));

        // 画面表示
        document.getElementById('tableDisplay').textContent =
          `テーブル番号：${tableParam}`;

        // 注文履歴取得
        fetchOrderHistory(tableParam);
      }
    });

    // ===============================
    // フォーム変更時
    // 注文ボタン活性/非活性制御
    // ===============================
    form.addEventListener('change', () => {

      const hasOrder =
        parseInt(form.parfait.value) > 0 ||
        parseInt(form.special.value) > 0 ||
        parseInt(form.plate.value) > 0 ||
        form.drink.value !== "0";

      const hasTable = form.table.value !== "";

      submitBtn.disabled = !(hasOrder && hasTable);

      document.getElementById('thanksMessage').style.display = 'none';
    });

    // ===============================
    // 注文送信処理
    // ===============================
    form.addEventListener('submit', async (e) => {

      e.preventDefault();

      const data = {
        table_number: form.table.value,
        parfait: parseInt(form.parfait.value),
        special: parseInt(form.special.value),
        plate: parseInt(form.plate.value),
        drink: form.drink.value,
        message: form.message.value.trim(),
        created_at: new Date().toISOString()
      };

      try {

        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "apikey": SUPABASE_API_KEY,
              "Authorization": `Bearer ${SUPABASE_API_KEY}`,
              "Prefer": "return=minimal"
            },
            body: JSON.stringify(data)
          }
        );

        if (response.ok) {

          alert("ご注文ありがとうございました！");

          form.reset();
          submitBtn.disabled = true;

          document.getElementById('thanksMessage').style.display = 'block';

          // 新しい注文履歴を再取得
          fetchOrderHistory(data.table_number);

        } else {
          alert("送信エラーが発生しました。");
          console.error(await response.text());
        }

      } catch (error) {
        alert("通信エラーが発生しました。");
        console.error(error);
      }
    });

    // ===============================
    // 注文履歴取得関数
    // ===============================
    async function fetchOrderHistory(tableNumber) {

      try {

        const res = await fetch(
          `${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}?table_number=eq.${tableNumber}&order=created_at.desc`,
          {
            headers: {
              "apikey": SUPABASE_API_KEY,
              "Authorization": `Bearer ${SUPABASE_API_KEY}`
            }
          }
        );

        const orders = await res.json();
        const historyList = document.getElementById("historyList");

        historyList.innerHTML = "";

        if (orders.length === 0) {
          historyList.innerHTML = "<p>注文履歴がありません。</p>";
          return;
        }

        for (const order of orders) {

          const item = document.createElement("div");
          item.className = "history-item";

          item.innerHTML = `
            <div class="history-time">
              ${new Date(order.created_at).toLocaleString()}
            </div>
            <div>
              スイーツパフェ：${order.parfait}
              / スペシャルパフェ：${order.special}
              / スイーツプレート：${order.plate}
              / ドリンク：${order.drink || "なし"}
            </div>
          `;

          historyList.appendChild(item);
        }

      } catch (error) {
        console.error("注文履歴の取得に失敗しました:", error);
      }
    }

  </script>

</body>
</html>